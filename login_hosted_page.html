<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Sign In Orchard</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style>
            body, html {
                height: 100%;
                background-color: #f9f9f9;
            }

            .login-container {
                /*position: relative;*/
                height: 100%;
            }

            .login-box {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                padding: 15px;
                background-color: #fff;
                box-shadow: 0px 5px 5px #ccc;
                border-radius: 5px;
                border-top: 1px solid #e9e9e9;
            }

            .login-header {
                text-align: center;
                padding-bottom: 30px;
            }

            .login-header img {
                width: 75px;
            }

            #error-message {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="login-container" id="tab-login">
            <div class="col-xs-12 col-sm-4 col-sm-offset-4 login-box">
                <div class="login-header">
                    <img src="http://www.theorchard.com/wp-content/themes/skm-framework/assets/images/orchard-dark.svg"/>
                    <h3>Welcome</h3>
                    <h5>PLEASE LOG IN</h5>
                </div>
                <div id="error-message" class="alert alert-danger"></div>
                <form onsubmit="return false;" method="post">
                    <div class="form-group">
                        <label for="name">username / Email</label>
                        <input
                            type="text"
                            class="form-control"
                            id="username"
                            placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label for="name">Password</label>
                        <input
                            type="password"
                            class="form-control"
                            id="password"
                            placeholder="Enter your password">
                    </div>
                    <button
                        type="submit"
                        id="btn-login"
                        class="btn btn-primary btn-block">
                        Log In
                    </button>
                </form>
            </div>
        </div>

        <div class="login-container" id="tab-signup-email" >
            <div class="col-xs-12 col-sm-4 col-sm-offset-4 login-box">
                <div class="login-header">
                    <img src="http://www.theorchard.com/wp-content/themes/skm-framework/assets/images/orchard-dark.svg"/>
                    <h1 class="title-text mt3_row-gut-1">Welcome to The Orchard.</h1>
                    <h3 class="mt3_col-gut mt3_row-gut-2 subtitle-text">Time to upgrade your credentials..</h3>
                    <h5>We are making it better and more secure. Please confirm your details below are good, before we proceed further.</h5>
                </div>

                <div id="error-message" class="alert alert-danger"></div>
                <form onsubmit="return false;" method="post">
                    <div class="form-group">
                        <label for="signup-email">*Your Email <i>(that will be used for future logins)</i>:</label>
                        <input
                            type="email"
                            class="form-control"
                            id="signup-email"
                            placeholder="Your email">
                    </div>
                    <button
                        type="submit"
                        id="btn-signup-email"
                        class="btn btn-primary btn-block"> > </button>
                </form>
            </div>
        </div>


        <div class="login-container" id="tab-signup-password" >
            <div class="col-xs-12 col-sm-4 col-sm-offset-4 login-box">
                <div class="login-header">
                    <img src="http://www.theorchard.com/wp-content/themes/skm-framework/assets/images/orchard-dark.svg"/>
                    <h1 class="title-text mt3_row-gut-1">Welcome to The Orchard.</h1>
                    <h3 class="mt3_col-gut mt3_row-gut-2 subtitle-text">Time to upgrade your credentials..</h3>
                    <h5>We are making it better and more secure. Please confirm your details below are good, before we proceed further.</h5>
                </div>
                <div>
                    Requirement: At least 10 characters in length  and Contain at least 3 of the following 4 types of characters:
                    <ul>
                        <li>lower case letters (a-z)</li>
                        <li>upper case letters (A-Z)</li>
                        <li>numbers (i.e. 0-9)</li>
                        <li>special characters (e.g. !@#$%^&*) </li>
                        <li>No more than 2 identical characters in a row (e.g., "aaa" not allowed)"</li>
                    </ul>
                </div>>

                <div id="error-message" class="alert alert-danger"></div>
                <form onsubmit="return false;" method="post">
                    <div class="form-group">
                        <label for="signup-password">*Your password <i>(that will be used for further logins)</i>:</label>
                        <input
                            type="password"
                            class="form-control"
                            id="signup-password"
                            placeholder="Your password" />
                        <label for="signup-password">*Confirm password:</label>
                        <input
                            type="password"
                            class="form-control"
                            id="signup-confirm-password"
                            placeholder="Confirm password">
                    </div>
                    <button
                        type="submit"
                        id="btn-signup-password"
                        class="btn btn-primary btn-block"> > </button>
                </form>
            </div>
        </div>


        <div class="login-container" id="tab-confirm-merge" >
            <div class="col-xs-12 col-sm-4 col-sm-offset-4 login-box">
                <div class="login-header">
                    <img src="http://www.theorchard.com/wp-content/themes/skm-framework/assets/images/orchard-dark.svg"/>
                    <h1 class="title-text mt3_row-gut-1">Welcome to The Orchard.</h1>
                    <h3 class="mt3_col-gut mt3_row-gut-2 subtitle-text">Merge accounts.</h3>
                    <h5>This email already exist with some other accounts. Do you want to merge those to this email?</h5>
                </div>

                <div id="error-message" class="alert alert-danger"></div>
                <form onsubmit="return false;" method="post">
                    <div class="form-group">
                        <button
                            type="submit"
                            class="form-control"
                            id="btn-merge-yes"> Yes </button>
                        <button
                            type="submit"
                            class="form-control"
                            id="btn-merge-no"> No </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="login-container" id="tab-check-email" >
            <div class="col-xs-12 col-sm-4 col-sm-offset-4 login-box">
                <div class="login-header">
                    <img src="http://www.theorchard.com/wp-content/themes/skm-framework/assets/images/orchard-dark.svg"/>
                    <h1 class="title-text mt3_row-gut-1">Welcome to The Orchard.</h1>
                    <h3 class="mt3_col-gut mt3_row-gut-2 subtitle-text">Thank you for migrating.</h3>
                    <h5>Please check your email for a verification link. Click on the link in verification email to login to workstation.</h5>
                </div>
            </div>
        </div>

        <!--[if IE 8]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ie8/0.2.5/ie8.js"></script>
    <![endif]-->

        <!--[if lte IE 9]>
        <script src="https://cdn.auth0.com/js/polyfills/1.0/base64.min.js"></script>
        <script src="https://cdn.auth0.com/js/polyfills/1.0/es5-shim.min.js"></script>
        <![endif]-->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" ></script>
        <script src="https://cdn.auth0.com/js/auth0/9.2/auth0.min.js"></script>
        <script src="https://cdn.auth0.com/js/polyfills/1.0/object-assign.min.js"></script>
        <script>
                        $(function () {
                            var config = JSON.parse(
                                    decodeURIComponent(escape(window.atob('@@config@@')))
                                    );

                            var params = Object.assign({
                                domain: config.auth0Domain,
                                clientID: config.clientID,
                                redirectUri: config.callbackURL,
                                responseType: 'code'
                            }, config.internalOptions);

                            var webAuth = new auth0.WebAuth(params);
                            var loginConnection = 'art-relations';
                            var signupConnection = 'Username-Password-Authentication';
                            // for decision making later for intermediate stages.
                            var new_user = 0;
                            var vend_contact_id = 0;


                            // Startup show login form
                            $('#tab-login').show();
                            $('#tab-signup-password').hide();
                            $('#tab-confirm-merge').hide();
                            $('#tab-signup-email').hide();
                            $('#tab-check-email').hide();

                            /**
                             *
                             * @returns {undefined}
                             */
                            function orchardLogin() {
                                var username = $('#username').val();
                                var password = $('#password').val();
                                webAuth.login({
                                    realm: loginConnection,
                                    username: username,
                                    password: password,
                                }, function (err) {
                                    if (err && err.code == 'not-migrated') {
                                        console.log(err);
                                        hideError();
                                        var parts = err.description.split("|");
                                        $('#signup-email').val(parts[0]);
                                        if (parts.lenght > 1) {
                                            vend_contact_id = params[1];
                                        }
                                        askForEmail();
                                    } else {
                                        displayError(err);
                                    }
                                });
                            }

                            /**
                             *
                             * @returns {undefined}
                             */
                            function askForEmail() {
                                $('#tab-login').hide();
                                $('#tab-signup-password').hide();
                                $('#tab-confirm-merge').hide();
                                $('#tab-signup-email').show();
                                $('#tab-check-email').hide();
                            }

                            /**
                             *
                             * @returns {undefined}
                             */
                            function lookupEmail() {
                                var email = $('#signup-email').val();
                                var url = 'http://localhost:3003/head_response.json';
                                $.ajax({
                                    type: "GET",
                                    url: url,
                                    dataType: "json",
                                    success: function (response, status, xhr) {
                                        if (parseInt(response.auth0_user_count) > 0 || parseInt(response.orchard_user_count) > 0) {
                                            // auth0 account exist with this email OR dupe orchard email but neither signed up.
                                            new_user = (parseInt(response.auth0_user_count) > 0 ? 0 : 1);
                                            hideError();
                                            $('#tab-login').hide();
                                            $('#tab-signup-password').hide()();
                                            $('#tab-confirm-merge').show();
                                            $('#tab-signup-email').hide();
                                            $('#tab-check-email').hide();
                                        } else {
                                            // new user with no dupe email, so ask for password.
                                            hideError();
                                            new_user = 1;
                                            $('#tab-login').hide();
                                            $('#tab-signup-password').show();
                                            $('#tab-confirm-merge').hide();
                                            $('#tab-signup-email').hide();
                                            $('#tab-check-email').hide();
                                        }
                                    },
                                    failure: function (err) {
                                        console.error(err);
                                        displayError(err);
                                    }
                                });
                            }

                            /**
                             *
                             * @returns {undefined}
                             */
                            function askForPassword() {
                                $('#tab-login').hide();
                                $('#tab-signup-password').show();
                                $('#tab-confirm-merge').hide();
                                $('#tab-signup-email').hide();
                                $('#tab-check-email').hide();
                            }

                            /**
                             *
                             * @returns {undefined}
                             */
                            function signup() {
                                var username = $('#username').val();
                                var email = $('#signup-email').val();
                                var password = $('#signup-password').val();
                                console.log("sign up");
                                var params = {
                                    connection: loginConnection, // 'Username-Password-Authentication',
                                    email: email,
                                    password: password,
                                    user_metadata: {
                                        username: username,
                                        vend_contact_id: vend_contact_id.toString(),
                                        type: 'alw'}
                                };

                                console.log(params);
                                // Way 1:
//                                webAuth.signup(params, function (err) {
//                                    if (err) {
//                                        return displayError(err);
//                                    }
//                                    return checkYourEmail();
//
//                                });
                                // Way 2:
                                var db_username = username + "|" + email;
                                webAuth.login({
                                    realm: loginConnection,
                                    username: db_username,
                                    password: password,
                                }, function (err) {
                                    displayError(err);
                                });
                            }

                            function checkYourEmail() {
                                $('#tab-login').hide();
                                $('#tab-signup-password').hide();
                                $('#tab-confirm-merge').hide();
                                $('#tab-signup-email').hide();
                                $('#tab-check-email').show();
                            }

                            /**
                             *
                             * @returns {undefined}
                             */
                            function updateOrchardLogin() {
                                var username = $('#username').val();
                                var email = $('#signup-email').val();
                                var url = 'http://localhost:3003/head_response.json';
                                $.ajax({
                                    type: "PATCH",
                                    url: url,
                                    data: {'username': username, 'auth0_email': email},
                                    contentType: "application/json",
                                    dataType: "json",
                                    success: function (response, status, xhr) {
                                        $('#username').val(email);
                                        $('#tab-login').show();
                                        $('#tab-signup-password').hide();
                                        $('#tab-confirm-merge').hide();
                                        $('#tab-signup-email').hide();
                                    },
                                    failure: function (err) {
                                        console.error(err);
                                        displayError(err);
                                    }
                                });
                            }


                            function hideError() {
                                $('.alert-danger').html('').hide();
                            }

                            function displayError(err) {
                                console.log(err);
                                var message = 'Sorry invalid details.';
                                if (err.message) {
                                    message = err.message;
                                } else if (err.description && (typeof err.description === 'string' || err.description instanceof String)) {
                                    message = err.description;
                                } else if (err.name == 'PasswordStrengthError') {
                                    message = 'Password is not strong enough.';
                                }

                                $('.alert-danger').html(message).show();

                            }

                            // Event listners
                            $('#btn-login').on('click', function () {
                                orchardLogin();
                            });
                            $('#btn-signup-email').on('click', function () {
                                lookupEmail();
                            });
                            $('#btn-merge-no').on('click', function () {
                                askForEmail();
                            });
                            $('#btn-signup-password').on('click', function () {
                                signup();
                            });
                            $('#btn-merge-yes').on('click', function () {
                                if (new_user > 0) {
                                    // new user who agreed to merge his orchard email accounts.
                                    askForPassword();
                                } else {
                                    // user switching to already auth0 email
                                    updateOrchardLogin();
                                }

                            });
                        });
        </script>

    </body>
</html>
