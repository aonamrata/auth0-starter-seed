<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Sign In Orchard</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style>
            .full-page {
                /*position: relative;*/
                height: 100%;
                background-color: #F2F2F2;
            }
            .main-box {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                box-shadow: 0 0 20px 2px #A4A4A4;
            }
            .row {
                padding: 15px;
            }
            .header {
                border-radius: 5px 5px 0 0;
            }
            .grey-header {
                text-align: center;
                background-color: #e3e3e3;
            }
            .blue-header {
                background-color: #13395F;
                color: white;
                text-align: justify;

            }
            .white-body {
                background-color:white;
            }
            .btn-link {
                color: darkslategray;
            }
            .btn-link:focus, .btn-link:hover {
                color: black;
            }
            .orange-footer {
                background-color: #f48b41;
            }
            .grey-footer {
                background-color: #e3e3e3;
            }
            .grey-btn {
                border: 0 none;
                color: white;
                background-color: #e3e3e3;
            }
            .grey-btn:focus, .grey-btn:hover, .grey-btn:target, .grey-btn:active {
                border: 0 none;
                background-color: #e3e3e3;
            }
            .orange-btn {
                border: 0 none;
                color: white;
                background-color: #f48b41;
            }
            .orange-btn:focus, .orange-btn:hover, .orange-btn:target, .orange-btn:active {
                border: 0 none;
                background-color: #f48b41;
            }
            .alert {
                margin-bottom: 0px;
            }
            .error-message {
                display: none;
            }
            .success-message {
                display: none;
            }
            small {
                color: grey;
            }
            .rules {
                padding-left: 2em;
                list-style-type: none;
            }
            li:before {
                position: absolute;
                margin-left: -1.3em;
                font-weight: bold;
            }
            .tick:before {
                content: "\2713";
                color: grey;
            }

        </style>
    </head>
    <body class="full-page">
        <div class="col-xs-12 col-sm-4 col-sm-offset-4 container-fluid main-box">

            <!-- ------------- login form ----------------- -->
            <div id="tab-login">
                <div class="row header grey-header">
                    <img src="https://www.theorchard.tv/img/favicons/favicon32.ico"/>
                    <h3>The Orchard</h3>
                </div>
                <div class="error-message row alert alert-danger"></div>
                <div class="success-message row alert alert-success"></div>
                <form method="post" id="login-form" action="http://alwmaster/login/authenticatev2">
                    <div class="row white-body">
                        <div class="form-group">
                            <input type="text" class="form-control" id="username" name="username" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="password" name="password" placeholder="Password">
                        </div>
                            <input type="hidden" class="form-control" name="login" value="auth0">
                            <input type="hidden" class="form-control" id="user-id" name="user_id" value="">
                            <button type="button" id="btn-forgot" class="btn btn-link"><small>Don't remember your password?</small></button>
                    </div>
                    <div class="row orange-footer">
                        <button type="button" id="btn-login" class="btn btn-block orange-btn"> LOG IN </button>
                    </div>
                </form>
            </div>

            <!-- ------------- Migrate Login Form ----------------- -->
            <div id="tab-signup-email">
                <div class="row header blue-header">
                    <h4>Please update your login information</h4>
                    <p>We're making The Orchard more secure. To help us keep your account protected, please update your username and password.</p>
                </div>
                <div class="error-message row alert alert-danger"></div>
                <form onsubmit="return false;" method="post">
                    <div class="row white-body">
                        <div class="form-group">
                            <strong>What email do you want to use to sign in?</strong>
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control" id="signup-email" placeholder="Email address">
                        </div>
                        <div class="form-group">
                            <small>Make sure to use email that you have access to. <br />
                                We'll send a confirmation link shortly.</small>
                        </div>
                    </div>
                    <div class="row orange-footer">
                        <button type="submit" id="btn-signup-email" class="btn btn-block orange-btn"> NEXT </button>
                    </div>
                </form>
            </div>

            <!-- ------------- Get password Form ----------------- -->
            <div id="tab-get-password">
                <div class="row header blue-header">
                    <h4>Please update your login information</h4>
                    <p>To help us keep your account protected, please update your username and password.</p>
                </div>
                <div class="error-message row alert alert-danger"></div>
                <form onsubmit="return false;" method="post">
                    <div class="row white-body">
                        <div class="form-group">
                            <strong>Choose a new password.</strong>
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="signup-password" placeholder="Password">
                        </div>
                        <div class="form-group">
                            <small>
                                <ul class='rules'>
                                    <li class="tick">At least 10 characters in length </li>
                                    <li class="tick">Contains a upper case letter</li>
                                    <li class="tick">Contains a numbers (i.e. 0-9)</li>
                                    <li class="tick">Contains a special characters (e.g. !@#$%^&*) </li>
                                </ul>
                            </small>
                        </div>
                    </div>
                    <div class="row orange-footer">
                        <button type="submit" id="btn-get-password" class="btn btn-block orange-btn"> NEXT </button>
                    </div>
                </form>
            </div>

            <!-- ------------- Verify email message ----------------- -->
            <div id="tab-verify-email">
                <div class="row header blue-header">
                    <h4>Check your email to verify</h4>
                    <p>Click the link in the email we sent you. That will officially update your credentials.</p>
                </div>
                <div class="error-message row alert alert-danger"></div>
                <div class="row white-body">
                    <div class="form-group">
                        <strong>Email sent to<p id='confirm-email'></p></strong>
                        Didn't get the email?<button type="button" id="btn-resend" class="btn btn-link">RESEND</button>
                    </div>
                </div>
            </div>

            <!-- ------------- Activate Single Sign ON ----------------- -->
            <div id="tab-single-signon">
                <div class="row header blue-header">
                    <h4>Check your email to activate Single Sign On!</h4>
                    <p>You have more than one account associated with your email.</p>
                </div>
                <div class="error-message row alert alert-danger"></div>
                <div class="success-message row alert alert-success"></div>
                <div class="row white-body">
                    <p>We just sent you a link that will enable you access to each of them with one set of credentials.</p>
                    <div class="form-group">
                        <p>Email sent to <strong class='confirm-email'></strong></p>
                        Didn't get the email?<button type="button" id="btn-resend" class="btn btn-link">RESEND</button>
                    </div>
                     <div class="form-group">
                         <br />
                         <p>Your single sign on username: <strong class='confirm-email'></strong></p>
                    </div>
                </div>
                <div class="row grey-footer">
                    <button type="submit" id="btn-back-signup-email" class="btn btn-block grey-btn"> GO BACK </button>
                </div>
            </div>

        </div>

        <!--[if IE 8]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ie8/0.2.5/ie8.js"></script>
    <![endif]-->

        <!--[if lte IE 9]>
        <script src="https://cdn.auth0.com/js/polyfills/1.0/base64.min.js"></script>
        <script src="https://cdn.auth0.com/js/polyfills/1.0/es5-shim.min.js"></script>
        <![endif]-->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" ></script>
        <script src="https://cdn.auth0.com/js/auth0/9.2/auth0.min.js"></script>
        <script src="https://cdn.auth0.com/js/polyfills/1.0/object-assign.min.js"></script>
        <script>
                    $(function () {
                        var config = JSON.parse(
                            decodeURIComponent(escape(window.atob('@@config@@')))
                        );
                        var params = Object.assign({
                            domain: config.auth0Domain,
                            clientID: config.clientID,
                            redirectUri: config.callbackURL,
                            responseType: 'code'
                        }, config.internalOptions);

                        var webAuth = new auth0.WebAuth(params);
                        var loginConnection = 'art-relations';
                        if (config.clientID === '0Nm5wzE5n3y5xPnVRsq4aeH4xhQ8cPej') {
                            loginConnection = 'Delegated-User-Admin';
                        }

                        // for decision making later for intermediate stages.
                        var new_user = 0;
                        var vend_contact_id = 0;

                        // Startup show login form
                        $('#tab-login').show();
                        $('#tab-signup-email').hide();
                        $('#tab-get-password').hide();
                        $('#tab-verify-email').hide();
                        $('#tab-single-signon').hide();


                        // Event listners
                        $('#btn-login').on('click', function () { orchardLogin(); });
                        $('#btn-forgot').on('click', function () { forgotPassword(); });
                        $('#btn-signup-email').on('click', function () { lookupEmail(); });
                        $('#btn-get-password').on('click', function () { signup(); });
                        $('#btn-back-signup-email').on('click', function () { askForEmail(); });

                        $('#signup-email').on('change keyup', function () {
                            if (isEmail($('#signup-email').val())) {
                                $('#btn-signup-email').removeClass('disabled');
                            } else {
                                $('#btn-signup-email').addClass('disabled');
                            }
                        });



                        /**
                         * Legacy login
                         * @returns {undefined}
                         */
                        function orchardLogin() {
                            var username = $('#username').val();
                            var password = $('#password').val();
                            webAuth.login({
                                realm: loginConnection,
                                username: username,
                                password: password,
                            }, function (err) {

                                if(err && err.code === 'dont-migrated') {
                                    var parts = err.description.split("|");
                                    $('#password').val(parts[0]);
                                    $('#user-id').val(parts[1]);
                                    $('#login-form').submit();
                                    hideError();
                                    displaySuccess('Login success. Redirecting..');
                                    return;
                                }else if (err && err.code === 'not-migrated') {
                                    console.log(err);
                                    hideError();
                                    var parts = err.description.split("|");
                                    $('#signup-email').val(parts[0]);
                                    $('#signup-email').change();
                                    if (parts.length > 1) {
                                        vend_contact_id = parts[1];
                                    }
                                    console.log('VC id=' + vend_contact_id);
                                    askForEmail();
                                } else {
                                    displayError(err);
                                }
                            });
                        }

                        /**
                         *
                         * @returns {undefined}
                         */
                        function askForEmail() {
                            $('#tab-login').hide();
                            $('#tab-signup-email').show();
                            $('#tab-get-password').hide();
                            $('#tab-verify-email').hide();
                            $('#tab-single-signon').hide();
                        }

                        /**
                         *
                         * @returns {undefined}
                         */
                        function lookupEmail() {
                            var email = $('#signup-email').val();
                            url1 = 'https://xn4nyishu3.execute-api.us-east-1.amazonaws.com/api/auth0/email/' + email;
//                            url2 = 'https://xn4nyishu3.execute-api.us-east-1.amazonaws.com/api/orchard/email/' + email;
                            $.ajax(url1)
                                .fail(function(jqXHR, textStatus){
                                    console.error(jqXHR.responseText);
                                    console.error(textStatus);
                                    return  displayError({'message': 'Something went wrong with checking this email. Try again.'});
                                })
                                .done(function (auth0_lookup) {
                                    if (auth0_lookup.result.length > 0) {
                                        // auth0 account exist with this email.
                                        new_user = 0;
                                        $('.confirm-email').html(email);
                                        hideError();
                                        $('#tab-login').hide();
                                        $('#tab-signup-email').hide();
                                        $('#tab-get-password').hide();
                                        $('#tab-verify-email').hide();
                                        $('#tab-single-signon').show();

//                                        auth0_id = auth0_lookup.result[0];
//                                        webAuth.login({
//                                            realm: loginConnection,
//                                            username: vend_contact_id + '|' + auth0_id,
//                                            password: email,
//                                        });
                                    } else {
                                        // new user with no dupe email, so ask for password.
                                        hideError();
                                        new_user = 1;
                                        $('#tab-login').hide();
                                        $('#tab-signup-email').hide();
                                        $('#tab-get-password').show();
                                        $('#tab-verify-email').hide();
                                        $('#tab-single-signon').hide();
                                    }
                            });
                        }


                        function isEmail(email) {
                            var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                            return regex.test(email);
                        }

                        /**
                         *
                         * @returns {undefined}
                         */
                        function signup() {
                            var username = $('#username').val();
                            var email = $('#signup-email').val();
                            var password = $('#signup-password').val();
                            console.log("sign up");
                            var params = {
                                connection: loginConnection, // 'Username-Password-Authentication',
                                email: email,
                                password: password,
                                user_metadata: {
                                    username: username,
                                    vend_contact_id: vend_contact_id.toString(),
                                    type: 'alw',
                                }
                            };
                            hideError();
                            console.log(params);
                            // Way 1:
                            webAuth.signup(params, function (err, result) {
                                if (err) {
                                    return displayError(err);
                                }
                                checkYourEmail();
                            });
                        }

                        function crossDomainPost(url, params) {
                            // Add the iframe with a unique name
                            let iframe = document.createElement("iframe");
                            let uniqueString = "forgot_legacy";
                            document.body.appendChild(iframe);
                            iframe.style.display = "none";
                            iframe.contentWindow.name = uniqueString;

                            // construct a form with hidden inputs, targeting the iframe
                            let form = document.createElement("form");
                            form.target = uniqueString;
                            form.action = url;
                            form.method = "POST";

                            addParams2Form(params, form);

                            document.body.appendChild(form);
                            form.submit();

                            function addParams2Form(arr, form) {
                              arr.forEach(function(item) {
                                let input = document.createElement("input");
                                input.type = "hidden";
                                input.name = item.name;
                                input.value = item.value;
                                form.appendChild(input);
                              });
                            }
                        }

                        /**
                         *
                         * @returns {undefined}
                         */
                        function forgotPassword() {
                            var username = $('#username').val();
                            if (!isEmail(username)) {
                                url = 'https://workstation.qaorch.com/login/forgot';
                                params = [  { name: "login", value: username }];
                                crossDomainPost(url, params);
                               return  displaySuccess('You are not migrated, so we have sent you a reset link to old system.');
                            } else {
                                hideError();
                                var params = {
                                    connection: loginConnection,
                                    email: username
                                  };
                                webAuth.changePassword(params, function (err, result) {
                                    if (err) {
                                        return displayError(err);
                                    }
                                    console.log(result);
                                    displaySuccess(result);
                                });
                            }

                        }


                        function checkYourEmail() {
                            $('#tab-login').hide();
                            $('#tab-signup-email').hide();
                            $('#tab-get-password').hide();
                            $('#tab-verify-email').show();
                            $('#tab-single-signon').hide();
                        }

                        function hideError() {
                            $('.alert-danger').html('').hide();
                        }

                        function displaySuccess(message){
                            $('.success-message').html(message).show();
                        }

                        function displayError(err) {
                            $('.success-message').hide();
                            console.log(err);
                            var message = 'Sorry invalid details.';
                            if (err.message) {
                                message = err.message;
                            } else if (err.description && (typeof err.description === 'string' || err.description instanceof String)) {
                                message = err.description;
                            } else if (err.name == 'PasswordStrengthError') {
                                message = 'Password is not strong enough.';
                            }

                            $('.alert-danger').html(message).show();
                        }
                    });
        </script>

    </body>
</html>
